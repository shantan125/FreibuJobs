# Azure Container Apps Configuration
apiVersion: 2022-03-01
location: East US
properties:
  managedEnvironmentId: /subscriptions/{subscription-id}/resourceGroups/linkedin-bot-rg/providers/Microsoft.App/managedEnvironments/linkedin-bot-env
  configuration:
    activeRevisionsMode: Single
    ingress:
      external: true
      targetPort: 8080
      allowInsecure: false
      traffic:
        - weight: 100
          latestRevision: true
    secrets:
      - name: telegram-bot-token
        keyVaultUrl: https://linkedin-bot-kv.vault.azure.net/secrets/telegram-bot-token
        identity: system
    registries:
      - server: linkedinbotacr.azurecr.io
        identity: system
  template:
    containers:
      - name: linkedin-bot
        image: linkedinbotacr.azurecr.io/linkedin-bot:latest
        env:
          - name: TELEGRAM_BOT_TOKEN
            secretRef: telegram-bot-token
          - name: AZURE_ENVIRONMENT
            value: production
          - name: LOG_LEVEL
            value: INFO
          - name: ENABLE_METRICS
            value: "true"
          - name: HEALTH_CHECK_ENABLED
            value: "true"
          - name: MAX_RESULTS_PER_SEARCH
            value: "10"
          - name: DEFAULT_LOCATION
            value: India
        resources:
          cpu: 0.5
          memory: 1Gi
        probes:
          - type: Liveness
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 30
          - type: Readiness
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
    scale:
      minReplicas: 0
      maxReplicas: 3
      rules:
        - name: http-scaling
          http:
            metadata:
              concurrentRequests: "10"
