name: ðŸš€ LinkedIn Bot Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: rg-linkedin-bot
  AZURE_CONTAINER_ENV: linkedin-bot-env
  AZURE_REGISTRY: linkedinbotacr
  CONTAINER_APP: linkedin-bot-app
  IMAGE_NAME: linkedin-bot

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”‘ Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ§© Install Azure CLI extensions
        run: |
          az extension add --name containerapp --upgrade

      - name: ðŸ”¨ Build and Deploy
        run: |
          # Build and push image
          az acr build \
            --registry ${{ env.AZURE_REGISTRY }} \
            --image ${{ env.IMAGE_NAME }}:latest \
            --file Dockerfile \
            .

          # Set/Update secret for Telegram token
          az containerapp secret set \
            --name ${{ env.CONTAINER_APP }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --secrets telegram-bot-token="${{ secrets.TELEGRAM_BOT_TOKEN }}"

          # Update container app image and environment variables
          az containerapp update \
            --name ${{ env.CONTAINER_APP }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.AZURE_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
            --set-env-vars \
              MAX_RESULTS_PER_SEARCH=10 \
              DEFAULT_LOCATION="India" \
              TELEGRAM_BOT_TOKEN=secretref:telegram-bot-token

      - name: âœ… Check Status
        run: |
          echo "ðŸŽ‰ Deployment completed!"
          az containerapp show \
            --name ${{ env.CONTAINER_APP }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "properties.runningStatus" -o tsv
